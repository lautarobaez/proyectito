<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>LanMonitor — Interfaz simple</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#06b6d4; --glass: rgba(255,255,255,0.03);
      --success:#10b981; --danger:#ef4444; --radius:12px; --pad:14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      color-scheme: dark;
    }
    body{background:linear-gradient(180deg,#071026 0%, #071127 60%); margin:0; min-height:100vh; color:#e6eef6}
    .wrap{max-width:1100px;margin:28px auto;padding:20px}
    header{display:flex;gap:16px;align-items:center;margin-bottom:18px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}
    .controls{display:flex;gap:10px;margin-left:auto}
    input[type=text]{background:var(--glass);border:1px solid rgba(255,255,255,0.04);padding:8px 10px;border-radius:8px;color:inherit}
    button{background:linear-gradient(180deg,var(--accent),#3dd5e6);border:none;padding:8px 12px;border-radius:10px;color:#04111a;font-weight:600;cursor:pointer}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}

    .layout{display:grid;grid-template-columns:1fr 360px;gap:18px}
    .card{background:var(--card);border-radius:var(--radius);padding:var(--pad);box-shadow:0 6px 30px rgba(2,6,23,0.6);}
    .hosts-table{width:100%;border-collapse:collapse}
    .hosts-table th, .hosts-table td{padding:10px 8px;text-align:left;font-size:13px}
    .hosts-table thead th{color:var(--muted);font-weight:600;border-bottom:1px solid rgba(255,255,255,0.04)}
    .row-ip{font-weight:600}
    .muted{color:var(--muted);font-size:12px}
    .small{font-size:12px}

    .host-online{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(16,185,129,0.12);color:var(--success);font-weight:600}
    .host-off{display:inline-block;padding:6px 8px;border-radius:999px;background:rgba(239,68,68,0.08);color:var(--danger);font-weight:600}

    .controls-row{display:flex;gap:8px;align-items:center;margin-bottom:12px}
    .footer-note{margin-top:10px;color:var(--muted);font-size:12px}

    /* responsive */
    @media (max-width:900px){.layout{grid-template-columns:1fr;}.controls{margin-top:8px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">LM</div>
        <div>
          <h1>LanMonitor — Interfaz simple</h1>
          <p class="lead">Escaneo de hosts y vista rápida de tráfico (demo). Fácil de integrar con tu backend.</p>
        </div>
      </div>

      <div class="controls">
        <input id="baseIp" type="text" value="192.168.1" title="Rango base (ej: 192.168.1)" />
        <button id="scanBtn">Iniciar escaneo</button>
        <button id="autoBtn" class="secondary">Auto: Off</button>
      </div>
    </header>

    <main class="layout">
      <section class="card">
        <div class="controls-row">
          <label class="small muted">Modo:</label>
          <select id="modeSelect">
            <option value="demo">Demo (sin permisos)</option>
            <option value="backend">Con backend (fetch /api/scan)</option>
          </select>

          <div style="margin-left:auto" class="muted small">Hosts activos: <span id="count">0</span></div>
        </div>

        <table class="hosts-table" id="hostsTbl">
          <thead>
            <tr><th>IP</th><th>Hostname</th><th>Bytes</th><th>Últ. visto</th></tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="footer-note">Consejo: el modo <strong>backend</strong> requiere un endpoint que haga el escaneo y devuelva JSON. El modo <strong>demo</strong> simula resultados para probar la UI.</div>
      </section>

      <aside class="card">
        <h3 style="margin-top:0">Tráfico (últimos 12s)</h3>
        <canvas id="trafficChart" width="360" height="180"></canvas>
        <div style="margin-top:12px;display:flex;gap:8px;justify-content:space-between">
          <button id="downloadCsv" class="secondary">Descargar CSV</button>
          <button id="clearBtn" class="secondary">Limpiar</button>
        </div>

        <div style="margin-top:14px" class="muted small">Nota: Para integrar con tu aplicación C# -> expón un endpoint REST que devuelva la lista de hosts en JSON con campos: ip, hostname, bytes, lastSeen (ISO).</div>
      </aside>
    </main>
  </div>

  <script>
    // --- UTILIDADES ---
    const hosts = new Map(); // ip -> {ip, hostname, bytes, lastSeen}

    const hostsTbody = document.querySelector('#hostsTbl tbody');
    const scanBtn = document.getElementById('scanBtn');
    const autoBtn = document.getElementById('autoBtn');
    const baseIpInput = document.getElementById('baseIp');
    const countSpan = document.getElementById('count');
    const modeSelect = document.getElementById('modeSelect');
    const downloadCsv = document.getElementById('downloadCsv');
    const clearBtn = document.getElementById('clearBtn');

    let auto = false; let autoInterval = null;

    // Chart.js setup
    const ctx = document.getElementById('trafficChart').getContext('2d');
    const chart = new Chart(ctx, {
      type: 'line',
      data: {labels: [], datasets:[{label:'Total bytes (sum)', data:[], tension:0.3}]},
      options: {responsive:true, plugins:{legend:{display:false}}}
    });

    function renderTable(){
      hostsTbody.innerHTML = '';
      const rows = Array.from(hosts.values()).sort((a,b)=>b.bytes - a.bytes);
      rows.forEach(h => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="row-ip">${h.ip}</td>
          <td class="muted">${h.hostname||'(no disponible)'}</td>
          <td>${formatBytes(h.bytes)}</td>
          <td class="small muted">${new Date(h.lastSeen).toLocaleTimeString()}</td>`;
        hostsTbody.appendChild(tr);
      });
      countSpan.textContent = rows.length;
    }

    function formatBytes(n){
      if(!n) return '0 B';
      const units=['B','KB','MB','GB']; let u=0; let val=n;
      while(val>=1024 && u<units.length-1){val/=1024;u++;}
      return val.toFixed(1)+ ' ' + units[u];
    }

    function updateChart(){
      const sum = Array.from(hosts.values()).reduce((s,h)=>s + (h.bytes||0),0);
      const now = new Date().toLocaleTimeString();
      chart.data.labels.push(now); chart.data.datasets[0].data.push(sum);
      if(chart.data.labels.length>12){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
      chart.update();
    }

    // --- SCAN LOGIC ---
    async function runScan(){
      const mode = modeSelect.value;
      if(mode === 'demo'){
        demoScan(baseIpInput.value);
      } else {
        // espera JSON {hosts:[{ip,hostname,bytes,lastSeen}]}
        try{
          const res = await fetch('/api/scan?base='+encodeURIComponent(baseIpInput.value));
          if(!res.ok) throw new Error('error en fetch');
          const json = await res.json();
          applyHostList(json.hosts || []);
        }catch(err){
          console.error(err); alert('Fallo al conectar con backend. Usa demo o verifica endpoint /api/scan');
        }
      }
      renderTable(); updateChart();
    }

    // Demo: genera hosts aleatorios para probar UI
    function demoScan(base){
      const now = new Date().toISOString();
      // crear entre 2 y 8 hosts
      const count = 3 + Math.floor(Math.random()*6);
      hosts.clear();
      for(let i=0;i<count;i++){
        const ip = base + '.' + (2 + Math.floor(Math.random()*250));
        hosts.set(ip, {ip, hostname: 'host-' + ip.split('.').pop(), bytes: Math.floor(Math.random()*1e7), lastSeen: now});
      }
    }

    function applyHostList(list){
      hosts.clear();
      list.forEach(h => {
        hosts.set(h.ip, {ip:h.ip, hostname:h.hostname || '', bytes: h.bytes || 0, lastSeen: h.lastSeen || new Date().toISOString()});
      });
    }

    // --- EVENTOS ---
    scanBtn.addEventListener('click', runScan);

    autoBtn.addEventListener('click', ()=>{
      auto = !auto;
      autoBtn.textContent = 'Auto: ' + (auto ? 'On' : 'Off');
      if(auto){ autoInterval = setInterval(runScan, 5000); } else { clearInterval(autoInterval); }
    });

    downloadCsv.addEventListener('click', ()=>{
      const rows = [['Fecha','IP','Hostname','Bytes']];
      hosts.forEach(h => rows.push([new Date(h.lastSeen).toISOString(), h.ip, h.hostname, h.bytes]));
      const csv = rows.map(r => r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'hosts.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    clearBtn.addEventListener('click', ()=>{ hosts.clear(); renderTable(); chart.data.labels=[]; chart.data.datasets[0].data=[]; chart.update(); });

    
    runScan();
  </script>

 
</body>
</html>
